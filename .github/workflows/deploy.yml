name: Deploy 

on: push
#   branches:
#     - main

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  NO_COLOR: 1

jobs:
  deploy-server:
    name: deploy pipe server
    runs-on: ubuntu-latest
    
    steps:
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      - uses: actions/checkout@v3
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - run: |
          cat << EOF > .cargo/config
          [net]
          git-fetch-with-cli = true
          EOF
          cd server 
          cargo vendor 
          make deploy_at_flyio

  deploy-client:
    name: deploy pipe client
    runs-on: ubuntu-latest
    steps:
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      - uses: actions/checkout@v3
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - run: |
          cat << EOF > .cargo/config
          [net]
          git-fetch-with-cli = true
          EOF
          cd client 
          cargo vendor 
          make deploy_at_flyio
